---
import Layout from "../layouts/Layout.astro";
import Icon from '../components/Icon.astro';
import { productsData } from '../components/product/productsData';
import { Image, getImage } from 'astro:assets';
import { productImages, getProductImage } from '../components/product/productImages';

const title = "ماسة فيشن | Masa Fashion";
const description = "متجر إلكتروني لبيع عبايات المخمل عالية الجودة في الأردن - عمان";
const canonical = "https://example.com";
const image = "https://example.com/og/masa-fashion.jpg";

// استيراد صورة Hero مباشرة
import heroImage from '../assets/products/product_6/4.jpg';

// استيراد صور المراجعات
const reviewImagesGlob = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/reviews/*.png',
  { eager: true }
);

// تحويل صور المراجعات إلى مصفوفة مرتبة
const reviewImages = Object.entries(reviewImagesGlob)
  .sort((a, b) => {
    const numA = parseInt(a[0].match(/(\d+)\.png$/)?.[1] || '0');
    const numB = parseInt(b[0].match(/(\d+)\.png$/)?.[1] || '0');
    return numA - numB;
  })
  .map(([_, module]) => module.default);

// تحويل البيانات إلى مصفوفة للتكرار عليها مع الصور المحسّنة
const products = await Promise.all(
  Object.entries(productsData).map(async ([id, product]) => {
    const imagePath = product.colors[0]?.image || '';
    const imageData = getProductImage(imagePath);
    
    // توليد صورة محسّنة بصيغة WebP
    const optimizedImage = imageData ? await getImage({
      src: imageData,
      width: 600,
      height: 800,
      format: 'webp',
    }) : null;
    
    return {
      id,
      ...product,
      mainImage: optimizedImage?.src || imagePath,
      originalImage: imagePath,
    };
  })
);
---

<Layout title={title} description={description} canonical={canonical} image={image}>

  {/* Background Decoration */}
  <div class="blob-bg" aria-hidden="true">
    <div class="blob blob-1 rounded-full"></div>
    <div class="blob blob-2 rounded-full"></div>
    <div class="blob blob-3 rounded-full"></div>
  </div>

  {/* HERO */}
  <section id="home" class="relative min-h-screen flex items-center pt-12 overflow-hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">

        <div class="text-center md:text-right z-10 space-y-6" data-aos="fade-right">
          <span class="inline-block py-1 px-3 rounded-full bg-white/60 border border-white/50 text-xs font-semibold tracking-wider text-gray-500 uppercase backdrop-blur-sm mb-2 mt-10">
            تشكيلة جديدة 2025
          </span>

          <h1 class="text-5xl md:text-7xl font-bold tracking-tight leading-tight" style="color: var(--textDark);">
            الأناقة بلمسة <br />
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-gray-900 to-gray-500">عباية فاخرة.</span>
          </h1>

          <p class="mt-4 max-w-lg mx-auto md:mx-0 text-xl leading-relaxed" style="color: var(--textLight);">
            عبايات مخمل شتوية فاخرة أنيقة راقية مميزة
            دفء، راحة، وأناقة خيارك المثالي لكل يوم ولمناسباتك الخاصة.
          </p>

          <div class="mt-8 flex flex-col sm:flex-row justify-center md:justify-start gap-4">
            <a href="#products" class="px-8 py-4 bg-black text-white rounded-full font-medium shadow-lg hover:shadow-gray-500/30 hover:bg-gray-900 transition-all transform hover:-translate-y-1">
              تصفح المجموعة
            </a>
          </div>
        </div>

        <div class="relative z-10 mt-10 md:mt-0" data-aos="zoom-in">
          <div class="glass-card rounded-[2.5rem] p-4 hover:rotate-0 transition-transform duration-700">
            <div class="relative overflow-hidden rounded-[2rem] bg-gray-50/50">
              <Image
                src={heroImage}
                alt="عارضة أزياء ترتدي عباية من ماسة فيشن"
                class="object-contain w-full h-auto max-h-[600px] hover:scale-105 transition-transform duration-1000"
                loading="eager"
                decoding="async"
                fetchpriority="high"
                widths={[400, 600, 800, 1000]}
                sizes="(max-width: 768px) 100vw, 50vw"
                format="webp"
                quality={80}
              />
            </div>
          </div>

         

      </div>
    </div>
  </section>

  {/* PRODUCTS */}
  <section id="products" class="py-24 relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-16" data-aos="fade-up">
        <h2 class="text-3xl md:text-5xl font-bold mb-4" style="color: var(--textDark);">الأكثر مبيعاً</h2>
        <p class="max-w-2xl mx-auto text-lg" style="color: var(--textLight);">
          اخترنا لك بعناية أفضل القطع التي نالت إعجاب عملائنا.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {products.map((product, index) => (
          <div data-aos="fade-up" data-aos-delay={index * 100}>
            <a href={`/product/${product.id}`} class="glass-card rounded-3xl p-4 h-full flex flex-col group cursor-pointer">
              <div class="relative overflow-hidden rounded-2xl aspect-[3/4] mb-6 bg-gray-100">
                <img
                  src={product.mainImage}
                  srcset={`${product.mainImage} 1x`}
                  alt={product.name}
                  class="object-cover w-full h-full group-hover:scale-110 transition-transform duration-500"
                  loading="lazy"
                  decoding="async"
                  width="600"
                  height="800"
                />
                {product.outofstock ? (
                  <div class="absolute top-4 right-4 bg-red-500 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-white shadow-sm">
                    غير متوفر
                  </div>
                ) : index === 0 && (
                  <div class="absolute top-4 right-4 bg-white/80 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-black shadow-sm">
                    جديد
                  </div>
                )}
              </div>
              <h3 class="text-xl font-bold mb-2" style="color: var(--textDark);">{product.name}</h3>
              <p class="text-sm mb-4 line-clamp-2" style="color: var(--textLight);">
                {product.description}
              </p>
              <div class="mt-auto flex justify-between items-center">
                <span class="text-lg font-bold text-black">{product.price} شامل التوصيل</span>
                <span class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center group-hover:bg-gray-800 transition">
                  <Icon name="arrow-left" class="text-sm" />
                </span>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>

  {/* TESTIMONIALS */}
  <section id="testimonials" class="py-24 relative overflow-hidden">
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[100%] bg-gradient-to-b from-transparent via-white/40 to-transparent pointer-events-none"></div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="text-center mb-16" data-aos="fade-up">
        <h2 class="text-3xl md:text-5xl font-bold mb-4" style="color: var(--textDark);">ماذا يقول عملاؤنا؟</h2>
        <p class="max-w-2xl mx-auto text-lg" style="color: var(--textLight);">آراء حقيقية من عملائنا الكرام</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="reviewsGrid">
        {reviewImages.map((reviewImg, i) => {
          return (
            <button
              type="button"
              class="glass-card rounded-2xl overflow-hidden group cursor-pointer"
              data-review-index={i}
              aria-label={`فتح صورة رأي عميل رقم ${i + 1}`}
              data-aos="zoom-in"
              data-aos-delay={i * 50}
            >
              <div class="relative aspect-square overflow-hidden">
                <Image
                  src={reviewImg}
                  alt="رأي عميل"
                  class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                  loading="lazy"
                  decoding="async"
                  width={400}
                  height={400}
                  format="webp"
                  quality={75}
                />
                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-300 flex items-center justify-center">
                  <span class="text-white text-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300"><Icon name="search-plus" class="text-xl" /></span>
                </div>
              </div>
            </button>
          );
        })}
      </div>
    </div>
  </section>

  {/* Review Modal */}
  <div id="reviewModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-label="عارض صور الآراء">
    <div class="relative max-w-4xl max-h-[90vh] w-full">
      <button id="closeReview" class="absolute bottom-4 right-4 md:bottom-auto md:right-auto md:-top-12 md:left-1/2 md:-translate-x-1/2 lg:left-auto lg:translate-x-0 lg:-left-12 w-10 h-10 rounded-full bg-black/70 md:bg-white/20 text-white flex items-center justify-center hover:bg-black/90 md:hover:bg-white/40 transition z-10" aria-label="إغلاق">
        <Icon name="times" class="text-lg" />
      </button>

      <img id="modalImage" src="" alt="رأي عميل" class="w-full h-auto max-h-[85vh] object-contain rounded-2xl shadow-2xl" />

      <button id="nextReview" class="absolute top-1/2 -translate-y-1/2 right-2 md:-right-14 w-10 h-10 rounded-full bg-black md:bg-white/20 text-white flex items-center justify-center hover:bg-gray-800 md:hover:bg-white/40 transition" aria-label="التالي">
        <Icon name="chevron-right" class="text-sm" />
      </button>
      <button id="prevReview" class="absolute top-1/2 -translate-y-1/2 left-2 md:-left-14 w-10 h-10 rounded-full bg-black md:bg-white/20 text-white flex items-center justify-center hover:bg-gray-800 md:hover:bg-white/40 transition" aria-label="السابق">
        <Icon name="chevron-left" class="text-sm" />
      </button>
    </div>
  </div>

  {/* JS خفيف ومؤجل */}
  <script is:inline defer define:vars={{ reviewImageUrls: reviewImages.map(img => img.src) }}>
    


    // Reviews modal (event delegation)
    // استخدام URLs الصور المحسّنة من Astro
    let currentReviewIndex = 0;

    const modal = document.getElementById("reviewModal");
    const modalImage = document.getElementById("modalImage");
    const closeBtn = document.getElementById("closeReview");
    const nextBtn = document.getElementById("nextReview");
    const prevBtn = document.getElementById("prevReview");
    const grid = document.getElementById("reviewsGrid");

    const openModal = (index) => {
      currentReviewIndex = index;
      modalImage.src = reviewImageUrls[index];
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.documentElement.style.overflow = "hidden";
    };

    const closeModal = () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.documentElement.style.overflow = "";
      modalImage.src = "";
    };

    const navigate = (dir) => {
      currentReviewIndex = (currentReviewIndex + dir + reviewImageUrls.length) % reviewImageUrls.length;
      modalImage.src = reviewImageUrls[currentReviewIndex];
    };

    grid?.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-review-index]");
      if (!btn) return;
      openModal(parseInt(btn.getAttribute("data-review-index")));
    });

    closeBtn?.addEventListener("click", closeModal);
    modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    nextBtn?.addEventListener("click", (e) => { e.stopPropagation(); navigate(-1); });
    prevBtn?.addEventListener("click", (e) => { e.stopPropagation(); navigate(1); });

    document.addEventListener("keydown", (e) => {
      if (modal.classList.contains("hidden")) return;
      if (e.key === "Escape") closeModal();
      if (e.key === "ArrowLeft") navigate(1);
      if (e.key === "ArrowRight") navigate(-1);
    });
  </script>
</Layout>
